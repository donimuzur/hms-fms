angular.module("eprocAppPanitia").controller("bukaLockRekananCtrl",function($scope,$http,$cookieStore,$stateParams,$rootScope,$modal,$state){var page_id=14;$scope.totalItems=0;$scope.currentPage=1;$scope.maxSize=10;$scope.requests=[];$scope.userBisaMengatur;$scope.menuhome=0;var status=Number($stateParams.status);$scope.sStatus=1;$scope.init=function(){$scope.menuhome=$rootScope.menuhome;if(status===2)$scope.sStatus=2;$rootScope.getSession().then(function(result){$rootScope.userSession=result.data.data;
$rootScope.userLogin=$rootScope.userSession.session_data.username;$rootScope.authorize(loadRequest())})};function loadRequest(){var param=[];param.push($rootScope.userlogged);param.push(page_id);$http.post($rootScope.url_api+"roles/check_authority",{username:$rootScope.userLogin,page_id:page_id,jenis_mengatur:1}).success(function(reply){console.info("us: "+$rootScope.userLogin);if(reply.status===200){var data=reply.result.data;if(data.length>0)$scope.userBisaMengatur=data[0].bisa_mengatur}else{$.growl.error({message:"Gagal mendapatkan data hak akses!"});
return}}).error(function(err){$.growl.error({message:"Gagal Akses API >"+err});return});loadcount();$scope.jLoad(1)}function loadcount(){$rootScope.loadLoading("Silahkan Tunggu...");$scope.currentPage=1;$http.post($rootScope.url_api+"pud/count",{page_id:page_id,value:$scope.sStatus}).success(function(reply){if(reply.status===200)$scope.totalItems=reply.result.data;else{$.growl.error({message:"Gagal mendapatkan data permintaan buka lock!"});return}}).error(function(err){$.growl.error({message:"Gagal Akses API >"+
err});return})}function loadData(current){$scope.requests=[];$scope.currentPage=current;$scope.offset=current*10-10;$rootScope.loadLoading("Silahkan Tunggu...");var limit=10;$http.post($rootScope.url_api+"pud/select",{offset:$scope.offset,limit:limit,page_id:page_id,value:$scope.sStatus}).success(function(reply){if(reply.status===200){$scope.requests=reply.result.data;for(var i=0;i<$scope.requests.length;i++){if($scope.requests[i].awal_ubah_data!=="")$scope.requests[i].awal_ubah_data=$rootScope.convertTanggal($scope.requests[i].awal_ubah_data);
if($scope.requests[i].akhir_ubah_data!=="")$scope.requests[i].akhir_ubah_data=$rootScope.convertTanggal($scope.requests[i].akhir_ubah_data)}$rootScope.unloadLoading()}else{$.growl.error({message:"Gagal mendsapatkan data permintaan buka lock!"});return;$rootScope.unloadLoading()}}).error(function(err){$.growl.error({message:"Gagal Akses API >"+err});return;$rootScope.unloadLoading()})}$scope.jLoad=function(current){if(current===1)loadData(current);else $rootScope.authorize(loadData(current))};$scope.cariByStatus=
function(){$scope.jLoad(1);$rootScope.authorize(loadcount())};$scope.eksekusi=function(id_permintaan,rekanan_id,nama_perusahaan,email,email_pribadi){var kirim={id_permintaan:id_permintaan,rekanan_id:rekanan_id,nama_perusahaan:nama_perusahaan,email:email,email_pribadi:email_pribadi};var modalInstance=$modal.open({templateUrl:"BukaLock.html",controller:bukaLockCtrl,resolve:{item:function(){return kirim}}});modalInstance.result.then(function(){$rootScope.authorize(loadRequest())})};$scope.hapuslock=
function(req){bootbox.confirm("Anda yakin menghapus permintaan ubah data ini ?",function(rmv){if(rmv){var lock_id=req.id_permintaan;$rootScope.authorize($http.post($rootScope.url_api+"pud/delete",{lockid:lock_id}).success(function(reply){if(reply.status===200){$.growl.notice({title:"[INFO]",message:"Permintaan Ubah Data Berhasil Dihapus"});$scope.init()}else{$.growl.error({title:"[PERINGATAN]",message:"Data Gagal Dihapus"});return}}).error(function(err){$.growl.error({message:"Gagal Akses API >"+
err});return}))}})}});
var bukaLockCtrl=function($scope,$modalInstance,item,$http,$cookieStore,$rootScope){var page_id=14;$scope.tanggal=new Tanggal("","");$scope.buka=function(){if($scope.tanggal.awal===""){$.growl.error({title:"[PERINGATAN]",message:"Tanggal awal masih kosong"});return}if($scope.tanggal.akhir===""){$.growl.error({title:"[PERINGATAN]",message:"Tanggal akhir masih kosong"});return}$rootScope.loadLoadingModal("Silahkan Tunggu...");$rootScope.authorize($http.post($rootScope.url_api+"pud/approve",{id_permintaan:item.id_permintaan,
awal_ubah_data:$scope.tanggal.awal,akhir_ubah_data:$scope.tanggal.akhir,rekanan_id:item.rekanan_id,nama_perusahaan:item.nama_perusahaan,email:item.email,email_pribadi:item.email_pribadi,page_id:page_id,username:$rootScope.userLogin}).success(function(reply){if(reply.status===200){$.growl.notice({title:"[INFO]",message:"Berhasil mengapprove permintaan ubah data"});$("#divBukaLock").unblock();$rootScope.unloadLoadingModal();$modalInstance.close()}else{$.growl.error({message:"Gagal approve permintaan ubah data!"});
$rootScope.unloadLoadingModal();$modalInstance.close();return}}).error(function(err){$.growl.error({message:"Gagal Akses API >"+err});return}))};$scope.keluar=function(){$modalInstance.dismiss("cancel")}};function Tanggal(awal,akhir){var self=this;self.awal=awal;self.akhir=akhir};